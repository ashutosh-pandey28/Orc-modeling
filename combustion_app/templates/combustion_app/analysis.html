{% extends 'combustion_app/base.html' %}

{% block content %}
<div class="card">
    <h2>Parametric "What-If" Analysis</h2>
    <p>Select a fuel and a variable to sweep across a range. This tool will plot the impact on Efficiency, Cost, and Emissions.</p>
    
    <form method="post">
        {% csrf_token %}
        
        <table style="width: 100%;">
            {{ form.as_table }}
        </table>
        
        <button type="submit" class="btn" style="margin-top: 20px;">Run Analysis</button>
    </form>
</div>

{% if chart_data %}
<div class="card">
    <h3>Analysis Results (vs. {{ chart_data.x_axis_label }})</h3>
    <p>Showing impact on Efficiency, Cost of Energy, and CO Emissions.</p>
    
    <div style="width: 100%; height: 400px; margin-bottom: 30px;">
        <canvas id="efficiencyChart"></canvas>
    </div>
    <div style="width: 100%; height: 400px; margin-bottom: 30px;">
        <canvas id="costChart"></canvas>
    </div>
    <div style="width: 100%; height: 400px;">
        <canvas id="coChart"></canvas>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
{% if chart_data %}
<script>
    const analysisData = JSON.parse('{{ chart_data|safe }}');
    const xLabels = analysisData.labels.map(val => val.toFixed(2));
    const xAxisLabel = analysisData.x_axis_label;

    // --- Chart 1: Efficiency ---
    new Chart(document.getElementById('efficiencyChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: xLabels,
            datasets: [{
                label: 'Efficiency (%)',
                data: analysisData.efficiency_data,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { title: { display: true, text: xAxisLabel } },
                y: { title: { display: true, text: 'Efficiency (%)' } }
            }
        }
    });

    // --- Chart 2: Cost ---
    new Chart(document.getElementById('costChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: xLabels,
            datasets: [{
                label: 'Cost of Energy (₹/GJ)',
                data: analysisData.cost_data,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { title: { display: true, text: xAxisLabel } },
                y: { title: { display: true, text: 'Cost (₹/GJ)' } }
            }
        }
    });

    // --- Chart 3: CO Emissions ---
    new Chart(document.getElementById('coChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: xLabels,
            datasets: [{
                label: 'CO Emissions (ppm)',
                data: analysisData.co_data,
                borderColor: 'rgba(153, 102, 255, 1)',
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { title: { display: true, text: xAxisLabel } },
                y: { title: { display: true, text: 'CO (ppm)' } }
            }
        }
    });
</script>
{% endif %}
{% endblock %}