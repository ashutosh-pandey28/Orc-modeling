{% extends 'combustion_app/base.html' %}

{% block content %}
<div class="card">
    <h2>Parametric "What-If" Analysis</h2>
    <p>Select a fuel and a variable to sweep across a range. This tool will plot the impact on Efficiency, Cost, and Emissions.</p>
    
    <form method="post">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="{{ form.fuel.id_for_label }}">{{ form.fuel.label }}</label>
            {{ form.fuel }}
        </div>
        <div class="form-group">
            <label for="{{ form.variable_to_sweep.id_for_label }}">{{ form.variable_to_sweep.label }}</label>
            {{ form.variable_to_sweep }}
        </div>
        <hr style="border:0; border-top: 1px solid #eee; margin: 20px 0;">
        
        <h4>Sweep Range:</h4>
        <div class="form-group">
            <label for="{{ form.start_value.id_for_label }}">{{ form.start_value.label }}</label>
            {{ form.start_value }}
        </div>
        <div class="form-group">
            <label for="{{ form.end_value.id_for_label }}">{{ form.end_value.label }}</label>
            {{ form.end_value }}
        </div>
        <div class="form-group">
            <label for="{{ form.steps.id_for_label }}">{{ form.steps.label }}</label>
            {{ form.steps }}
        </div>
        <hr style="border:0; border-top: 1px solid #eee; margin: 20px 0;">

        <h4>Constant Parameters:</h4>
        <div class="form-group" id="js-constant-moisture-group">
            <label for="{{ form.constant_moisture.id_for_label }}">{{ form.constant_moisture.label }}</label>
            {{ form.constant_moisture }}
        </div>
        <div class="form-group" id="js-constant-excess-air-group">
            <label for="{{ form.constant_excess_air.id_for_label }}">{{ form.constant_excess_air.label }}</label>
            {{ form.constant_excess_air }}
        </div>
        <div class="form-group">
            <label for="{{ form.constant_load.id_for_label }}">{{ form.constant_load.label }}</label>
            {{ form.constant_load }}
        </div>
        
        <button type="submit" class="btn" style="margin-top: 20px;">Run Analysis</button>
    </form>
</div>

{% if chart_data %}
<div class="card">
    <h3>Analysis Results (vs. {{ chart_data.x_axis_label }})</h3>
    <p>Showing impact on Efficiency, Cost of Energy, and CO Emissions.</p>
    
    <div style="width: 100%; height: 400px; margin-bottom: 30px;">
        <canvas id="efficiencyChart"></canvas>
    </div>
    <div style="width: 100%; height: 400px; margin-bottom: 30px;">
        <canvas id="costChart"></canvas>
    </div>
    <div style="width: 100%; height: 400px;">
        <canvas id="coChart"></canvas>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get references to the elements
        const sweepVar = document.getElementById('{{ form.variable_to_sweep.id_for_label }}');
        const moistureGroup = document.getElementById('js-constant-moisture-group');
        const excessAirGroup = document.getElementById('js-constant-excess-air-group');

        // Function to update form visibility
        function updateFormVisibility() {
            if (sweepVar.value === 'moisture_percent') {
                // Sweeping moisture, so HIDE constant moisture field
                moistureGroup.style.display = 'none';
                // SHOW constant excess air field
                excessAirGroup.style.display = 'block';
            } else { // Sweeping excess_air_percent
                // SHOW constant moisture field
                moistureGroup.style.display = 'block';
                // HIDE constant excess air field
                excessAirGroup.style.display = 'none';
            }
        }

        // Add event listener to the dropdown
        sweepVar.addEventListener('change', updateFormVisibility);
        
        // Run the function on page load to set the initial state
        updateFormVisibility();
    });
</script>

{% if chart_data %}
<script>
    const analysisData = JSON.parse('{{ chart_data|safe }}');
    const xLabels = analysisData.labels.map(val => val.toFixed(2));
    const xAxisLabel = analysisData.x_axis_label;

    // --- Chart 1: Efficiency ---
    new Chart(document.getElementById('efficiencyChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: xLabels,
            datasets: [{
                label: 'Efficiency (%)',
                data: analysisData.efficiency_data,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { title: { display: true, text: xAxisLabel } },
                y: { title: { display: true, text: 'Efficiency (%)' } }
            }
        }
    });

    // --- Chart 2: Cost ---
    new Chart(document.getElementById('costChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: xLabels,
            datasets: [{
                label: 'Cost of Energy (₹/GJ)',
                data: analysisData.cost_data,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { title: { display: true, text: xAxisLabel } },
                y: { title: { display: true, text: 'Cost (₹/GJ)' } }
            }
        }
    });

    // --- Chart 3: CO Emissions ---
    new Chart(document.getElementById('coChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: xLabels,
            datasets: [{
                label: 'CO Emissions (ppm)',
                data: analysisData.co_data,
                borderColor: 'rgba(153, 102, 255, 1)',
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { title: { display: true, text: xAxisLabel } },
                y: { title: { display: true, text: 'CO (ppm)' } }
            }
        }
    });
</script>
{% endif %}
{% endblock %}